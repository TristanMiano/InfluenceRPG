# Influence RPG Server (src)

This subdirectory contains the server-side code for the Influence RPG prototype. It is responsible for: user authentication, account management, game and character persistence, real-time chat (players and AI Game Master), and serving the front-end templates and static assets.

---

## 1. Overview

* **Framework:** FastAPI, with Jinja2 templates for server-side rendering and WebSocket support for live chat.
* **Database:** PostgreSQL accessed via psycopg2. All persistence logic lives in `src/db/` modules.
* **Authentication & Accounts:** Simple username/password flow, with hashed credentials managed in the `users` table.
* **Game Logic:** Creates and lists games, allows characters to join, and orchestrates chat between players and the AI GM.
* **LLM Integration:** A “/ws/game/{game\_id}/chat” WebSocket route supports both player messages and `/gm` triggers for narrative updates from a Gemini (or simulated) model.
* **Templates & Static Assets:** Jinja2 templates in `src/server/templates/` extend a common `base.html`. CSS and JS are modularized under `static/css/` and `static/js/`.

---

## 2. High-Level Architecture

```plaintext
Client Browser
   │
   ├─ HTTP ←→ FastAPI (Routes + Templates)
   │                ├─ / (login.html)
   │                ├─ /create-account
   │                ├─ /lobby
   │                ├─ /chat
   │                ├─ /api/game/... (REST API)
   │                └─ /character/... (REST API)
   │
   ├─ WebSocket (Game Chat)
   │         └─ /ws/game/{game_id}/chat
   │
   └─ Static Files (CSS/JS)
             └─ /static/

PostgreSQL ← psycopg2 ← src/db/*.py

LLM Client ← src/llm/*.py
```

---

## 3. Code Modules

### 3.1 `src/server/main.py`

* Mounts static files and templates
* Defines core HTTP routes:

  * **`/`**: Login page (GET), authentication (POST `/login`)
  * **`/create-account`**: Account creation form (GET/POST)
  * **`/lobby`**: Lobby UI (GET)
  * **`/chat`**: Chat UI (GET)
* Includes routers:

  * **Game REST API:** `src/server/game.py`
  * **Character REST API:** `src/server/character.py`
  * **Chat WebSocket:** `src/server/game_chat.py` and `src/server/chat.py`

### 3.2 `src/db/`

* **`character_db.py`** and **`game_db.py`**: CRUD operations for users, characters, games, and chat messages.

### 3.3 `src/auth/`

* **`auth.py`**: DB connection and `authenticate_user()` logic.
* **`create_account.py`**: CLI script to bootstrap new accounts.

### 3.4 `src/llm/`

* **`llm_client.py`**: Generic wrapper for Gemini or simulated LLM calls.
* **`gm_llm.py`**: Constructs and sends narrative prompts to the LLM for `/gm` triggers.

### 3.5 `src/server/templates/`

* **`base.html`**: Common page structure.
* **`login.html`, `create_account.html`, `lobby.html`, `chat.html`**: Extend `base.html`.

### 3.6 `src/server/static/`

* **CSS:** `style.css` for shared styles.
* **JS:** Modular scripts (`login.js`, `create_account.js`, `lobby.js`, `chat.js`) for page logic.

---

## 4. Development Workflow

1. **Environment**: Ensure PostgreSQL is running and `config/db_config.json` is configured.
2. **Install dependencies**: `pip install -r requirements_autogenerated.txt`
3. **Database migrations**: (Add in future) Use your preferred migration tool.
4. **Run server**: `python server_control.py start` (or `uvicorn src.server.main:app --reload`).
5. **Develop & Test**: Use built-in FastAPI test client in `src/test/` for login endpoints.

---

## 5. Next Steps

* Add database migrations (Alembic/SQLAlchemy).
* Improve error handling and validation (Pydantic schemas).
* Write integration tests for WebSocket chat and GM triggers.
* Dockerize the server for containerized deployments.

---

*This document should serve as a jumping-off point for new developers to understand and navigate the server codebase.*
